<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="api-key" content="{{ api_key }}" />
  <title>wlan-autoroam UI</title>
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <!-- External stylesheet -->
 <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
 <link rel="stylesheet" href="{{ url_for('static', filename='chat.css') }}">
</head>

<body>
  <div id="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <img src="{{ url_for('static', filename='favicon.ico') }}" alt="logo" class="logo">
        <span class="title">wlan-autoroam</span>
      </div>

      <div class="actions">
        <button id="btnDocs" class="btnDocs" onclick="window.open('/api/docs', '_blank')">API Docs (Beta)</button>
        <button id="btnAISettings" class="btnDocs">AI Settings</button>
        <button id="btnLogout" class="btnLogout">Logout</button>
      </div>
    </div>
  </div>


  <div class="container">
    <main id="app">
      <!-- ===== Header controls ===== -->
      <header id="headerBar" class="panel"
        style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;">

        <!-- Left side -->
        <div class="header-controls">
          <button id="saveBtn" class="pill">üíæ Save Results</button>
          <select id="loadDropdown" class="pill">
            <option value="" disabled selected style="display:none;">Load Results...</option>
          </select>
          <button id="downloadLogBtn" class="pill">‚¨áÔ∏è Debug Logs</button>
        </div>


        <!-- Right side -->
        <div style="display:flex;align-items:center;gap:8px;">
          <!-- ===== CLI ARG INPUTS ===== -->
          <div style="display:flex;gap:9px;align-items:center;flex-wrap:wrap;margin-left:8px;">
            <label for="iface" class="muted">iface:</label>
            <input id="iface" type="text" placeholder="wlan0"
              style="width:65px;background:var(--panel2);color:var(--text);
              border:1px solid var(--line);border-radius:6px;padding:4px 6px;">
            <label for="rssi" class="muted">min_rssi:</label>
            <input id="rssi" type="number" placeholder="-75"
              style="width:23px;background:var(--panel2);color:var(--text);
              border:1px solid var(--line);border-radius:6px;padding:4px 6px;">
          </div>
          <button class="btn" id="btnRunNow"
            style="background: var(--ok); color: var(--bg);">
            ‚ñ∂ Run Now
          </button>
          <button class="btnAnalyze" id="btnAnalyzeAI" style="margin-left:8px;">ü§ñ Analyze with AI</button>
          <span id="runStatus"
            style="color:var(--muted);font-size:0.9em;"></span>
        </div>
      </header>

      <!-- AI Analysis Panel -->
      <div class="panel ai-analysis-panel" style="display:none">
        <div class="ai-header">
          <h3>AI Analysis</h3>
          <button class="btn-close-ai">√ó</button>
        </div>
        <div class="chat-container">
          <div class="chat-messages"></div>
          <div class="chat-input-container">
            <textarea class="chat-input" placeholder="Ask a question about the roam data..."></textarea>
            <button class="chat-send">Send</button>
          </div>
        </div>
      </div>

      <!-- ===== Core report view ===== -->
      <section id="reportView">
        <div class="grid">
          <!-- Chart tile -->
          <div class="panel chartPanel">
            <h3>Roam Phase Durations (absolute, ms)</h3>
            <div class="chartWrap">
              <svg id="chart" aria-label="Roam phase chart"></svg>
            </div>
            <div class="legend" id="legend"></div>
            <div class="muted" style="margin-top:8px">
              Click legend chips to hide/show a phase. Hover bars for details.
            </div>
          </div>

          <!-- Metrics tile -->
          <aside class="panel metricsPanel">
            <h3>Cycle Summary</h3>
            <div class="headerPills" style="margin-bottom:10px">
              <div class="pill"><strong>SSID:</strong> <span id="hSsid">‚Äî</span></div>
              <div class="pill"><strong>Security:</strong> <span id="hSec">‚Äî</span></div>
              <div class="pill"><strong>Exec:</strong> <span id="hExec">‚Äî</span></div>
              <div class="pill"><strong>Started:</strong> <span id="hTime">‚Äî</span></div>
              <div class="pill"><strong>Notes:</strong> <span id="notesPill">‚Äî</span></div>
            </div>
            <div class="metrics" style="margin-top:auto">
              <div class="metric"><div class="label">Roams</div><div class="value" id="mRoams">‚Äî</div></div>
              <div class="metric"><div class="label">Success rate</div><div class="value" id="mSuccess">‚Äî</div></div>
              <div class="metric"><div class="label">Avg total</div><div class="value" id="mAvg">‚Äî</div></div>
              <div class="metric"><div class="label">Median total</div><div class="value" id="mMedian">‚Äî</div></div>
              <div class="metric"><div class="label">Fastest / Slowest</div><div class="value" id="mFS">‚Äî</div></div>
              <div class="metric"><div class="label">SSID Security</div><div class="value" id="mSecType">‚Äî</div></div>
            </div>
          </aside>
        </div>

        <!-- Candidate AP table -->
        <div class="panel">
          <h3>Candidate Access Points</h3>
          <div class="muted" style="margin-bottom:6px">Sorted by RSSI (desc)</div>
          <div style="overflow:auto">
            <table id="apTable">
              <thead>
                <tr>
                  <th>BSSID</th><th>Frequency (MHz)</th><th>RSSI (dBm)</th><th>QBSS Util (%)</th><th>QBSS STA Count</th>
                  <th>Auth Suites</th><th>MFP Flag</th><th>Supported Rates</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Roam details -->
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Roam Details</h3>
            <div id="roamsButtons">
              <button id="btnExpandAll" class="pill">Expand All</button>
              <button id="btnCollapseAll" class="pill">Collapse All</button>
            </div>
          </div>
          <div id="roams"></div>
        </div>
      </section>

      <!-- AI Analysis Panel -->
      <div class="panel ai-analysis-panel" style="display:none">
        <div class="ai-header">
          <h3>AI Analysis</h3>
          <button class="btn-close-ai">√ó</button>
        </div>
        <div class="chat-container">
          <div class="chat-messages"></div>
          <div class="chat-input-container">
            <textarea class="chat-input" placeholder="Ask a question about the roam data..."></textarea>
            <button class="chat-send">Send</button>
          </div>
        </div>
      </div>

      <!-- Future expansion -->
      <section id="controlPanel" class="panel" style="display:none"></section>
    </main>
  </div>

<div id="saveModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>Save Results</h3>
    <textarea id="notesInput" placeholder="Optional notes about this run..."></textarea>
    <div class="modal-actions">
      <button id="confirmSave">Save</button>
      <button id="cancelSave">Cancel</button>
    </div>
  </div>
</div>

<div id="aiSettingsModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>AI Settings</h3>
    <div style="display:flex;flex-direction:column;gap:8px;">
      <label>API Key (stored on this machine):</label>
      <input id="aiApiKey" type="password" placeholder="sk-..." style="width:100%" />

      <label>Model:</label>
      <select id="aiModel" style="width:100%">
        <option value="gpt-4o-mini">gpt-4o-mini</option>
        <option value="gpt-4o">gpt-4o</option>
        <option value="gpt-4">gpt-4</option>
        <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
        <option value="custom">Custom...</option>
      </select>
      <label id="aiModelCustomLabel" style="display:none">Custom model:</label>
      <input id="aiModelCustom" type="text" placeholder="enter custom model name" style="width:100%;display:none" />

      <label>Provider endpoint (optional):</label>
      <input id="aiEndpoint" type="text" placeholder="https://api.openai.com" style="width:100%" />
      <label>Temperature:</label>
      <input id="aiTemp" type="number" step="0.1" min="0" max="1" placeholder="0.2" />
      <label>Max tokens:</label>
      <input id="aiMaxTokens" type="number" placeholder="512" />

      <div style="margin-top:.5em;display:flex;gap:.5em;align-items:center;">
        <button id="aiTestBtn" class="btn">Test Connection</button>
        <span id="aiTestResult" class="ai-test-result"></span>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:12px;">
      <button id="saveAISettings">Save</button>
      <button id="cancelAISettings">Cancel</button>
    </div>
  </div>
</div>


  <!-- Tooltip + overlay -->
  <div id="tooltip" class="tip" style="display:none"></div>

  <div id="overlay" style="
    display:none;
    position:fixed;
    inset:0;
    background:rgba(11,15,20,0.9);
    color:var(--muted);
    z-index:9999;
    backdrop-filter: blur(4px);
    align-items:center;
    justify-content:center;
    flex-direction:column;
    gap:12px;
  ">
    <div class="spinner" style="
      width:36px;
      height:36px;
      border:4px solid var(--line);
      border-top-color:var(--ok);
      border-radius:50%;
      animation:spin 1s linear infinite;
    "></div>
    <div id="spinnerText">Running roam...</div>
    <pre id="logOutput" style="
      background:#0f1520;
      color:#d9eaff;
      font-size:0.85em;
      padding:12px;
      max-height:40vh;
      width:80vw;
      overflow:auto;
      border-radius:8px;
      box-shadow:0 0 12px #0008;
      text-align:left;
    "></pre>
  </div>

  <!-- External JS -->
  <script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
